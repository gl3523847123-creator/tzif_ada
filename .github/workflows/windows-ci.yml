# =============================================================================
# Windows CI Workflow - Full Test Suite
# =============================================================================
# Purpose:
#   Full continuous integration for Windows platform.
#   Runs on every push and PR to validate Windows compatibility.
#
# Tests:
#   - Library build with Windows platform adapter
#   - Unit tests (295 tests)
#   - Integration tests with Windows timezone detection
#   - Windows platform-specific tests (Win32 API + CLDR mapping)
#
# Platform:
#   - Windows Server 2022 (windows-latest = Windows 11 compatible)
#   - GNAT FSF via Alire
#   - MSYS2 shell for Unix-like tooling
# =============================================================================

name: Windows CI

on:
  push:
    branches: [main, develop, "feature/**"]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Enable debug logging'
        required: false
        default: 'false'

jobs:
  windows-build-and-test:
    name: Windows Build & Test
    runs-on: windows-latest

    steps:
      # -----------------------------------------------------------------------
      # Checkout
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # -----------------------------------------------------------------------
      # Setup Alire
      # -----------------------------------------------------------------------
      - name: Setup Alire
        uses: alire-project/setup-alire@v3
        with:
          version: 2.0.2

      # -----------------------------------------------------------------------
      # Replace local pin with GitHub URL pin for CI
      # -----------------------------------------------------------------------
      - name: Update functional pin for CI
        shell: bash
        run: |
          # Replace local path pin with GitHub URL pin (v2.2.1 tag commit SHA)
          sed -i "s|path = '../functional'|url = \"https://github.com/abitofhelp/functional.git\", commit = \"7375a09b789cc5fc5ad4e6a09ff1882a978f2248\"|" alire.toml
          echo "Updated pin to use GitHub URL (functional v2.2.1)"

      # -----------------------------------------------------------------------
      # Download IANA timezone data
      # -----------------------------------------------------------------------
      - name: Download IANA timezone data
        shell: bash
        run: |
          mkdir -p data/tzdata
          curl -sL https://data.iana.org/time-zones/releases/tzdata2024b.tar.gz | tar -xz -C data/tzdata
          echo "Downloaded IANA tzdata2024b"
          ls -la data/tzdata/

      # -----------------------------------------------------------------------
      # Build library with Windows platform
      # -----------------------------------------------------------------------
      - name: Build TZif library
        shell: bash
        run: |
          echo "Building TZif library for Windows..."
          alr build -- -XTZIF_OS=windows -j4
          echo "Library build complete"

      # -----------------------------------------------------------------------
      # Build unit tests
      # -----------------------------------------------------------------------
      - name: Build unit tests
        shell: bash
        run: |
          echo "Building unit tests..."
          alr exec -- gprbuild -P test/unit/unit_tests.gpr -XTZIF_OS=windows -p -j4
          echo "Unit tests build complete"

      # -----------------------------------------------------------------------
      # Build integration tests
      # -----------------------------------------------------------------------
      - name: Build integration tests
        shell: bash
        run: |
          echo "Building integration tests..."
          alr exec -- gprbuild -P test/integration/integration_tests.gpr -XTZIF_OS=windows -p -j4
          echo "Integration tests build complete"

      # -----------------------------------------------------------------------
      # Run unit tests
      # -----------------------------------------------------------------------
      - name: Run unit tests
        shell: bash
        env:
          TZIF_DATA_PATH: ${{ github.workspace }}/data/tzdata
        run: |
          echo "========================================"
          echo "Running Unit Tests"
          echo "========================================"
          echo "TZIF_DATA_PATH: $TZIF_DATA_PATH"
          ./test/bin/unit_runner.exe
          echo "Unit tests complete"

      # -----------------------------------------------------------------------
      # Run integration tests
      # -----------------------------------------------------------------------
      - name: Run integration tests
        shell: bash
        env:
          TZIF_DATA_PATH: ${{ github.workspace }}/data/tzdata
        run: |
          echo "========================================"
          echo "Running Integration Tests"
          echo "========================================"
          echo "TZIF_DATA_PATH: $TZIF_DATA_PATH"
          ./test/bin/integration_runner.exe
          echo "Integration tests complete"

      # -----------------------------------------------------------------------
      # Run Windows platform tests
      # -----------------------------------------------------------------------
      - name: Run Windows platform tests
        shell: bash
        env:
          TZIF_DATA_PATH: ${{ github.workspace }}/data/tzdata
        run: |
          echo "========================================"
          echo "Running Windows Platform Tests"
          echo "========================================"
          echo "TZIF_DATA_PATH: $TZIF_DATA_PATH"
          if [ -f "./test/bin/test_windows_platform.exe" ]; then
            ./test/bin/test_windows_platform.exe
          else
            echo "Windows platform test executable not found (may not be built)"
          fi
          echo "Windows platform tests complete"

      # -----------------------------------------------------------------------
      # Test Summary
      # -----------------------------------------------------------------------
      - name: Test Summary
        if: always()
        shell: bash
        run: |
          echo "========================================"
          echo "Windows CI Complete"
          echo "========================================"
          echo "Platform: windows-latest (Windows Server 2022)"
          echo "TZIF_OS: windows"
          echo "Alire: 2.0.2"
          echo ""
          echo "Tests executed:"
          echo "  - Unit tests"
          echo "  - Integration tests"
          echo "  - Windows platform tests"
