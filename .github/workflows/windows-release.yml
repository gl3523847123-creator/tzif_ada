# =============================================================================
# Windows Release Validation Workflow
# =============================================================================
# Purpose:
#   Pre-flight check for Windows compatibility during release preparation.
#   Called by release.py prepare script BEFORE tags are created.
#   Development is done on macOS; this workflow ensures Windows compatibility.
#
# Note: This workflow runs ONLY the Windows platform-specific tests
#   (a quick smoke test). For full Windows CI with all tests, see windows-ci.yml
#   which runs on every push/PR.
#
# Triggers:
#   - Manual dispatch only (called by release.py prepare)
#   - Can also be triggered manually from GitHub Actions UI for testing
#
# Tests:
#   - Windows platform timezone detection via Win32 API
#   - Windows-to-IANA timezone mapping (CLDR data)
#
# Note:
#   The xmlada dependency requires running from MSYS2 shell for configure
#   to work properly. The setup-alire action handles this automatically.
# =============================================================================

name: Windows Release Validation

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version being validated (e.g., 1.0.0)'
        required: false
        default: 'dev'
      ref:
        description: 'Git ref to checkout (branch, tag, or SHA)'
        required: false
        default: ''

jobs:
  windows-validation:
    name: Windows Build & Test
    runs-on: windows-latest

    steps:
      # -----------------------------------------------------------------------
      # Checkout
      # -----------------------------------------------------------------------
      - name: Checkout tzif repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}
          submodules: recursive

      # -----------------------------------------------------------------------
      # Setup Alire (functional dependency resolved from Alire index)
      # -----------------------------------------------------------------------
      - name: Setup Alire
        uses: alire-project/setup-alire@v3
        with:
          version: 2.0.2

      # -----------------------------------------------------------------------
      # Replace local pin with GitHub URL pin for CI
      # -----------------------------------------------------------------------
      - name: Update functional pin for CI
        shell: bash
        run: |
          # Replace local path pin with GitHub URL pin (v2.2.1 tag commit SHA)
          sed -i "s|path = '../functional'|url = \"https://github.com/abitofhelp/functional.git\", commit = \"7375a09b789cc5fc5ad4e6a09ff1882a978f2248\"|" alire.toml
          echo "Updated pin to use GitHub URL (functional v2.2.1)"
          cat alire.toml

      # -----------------------------------------------------------------------
      # Build Windows platform tests
      # -----------------------------------------------------------------------
      # Uses windows_platform_tests.gpr - a standalone project that doesn't
      # depend on gnatcoll or the full tzif_config.gpr dependencies.
      # This validates:
      # 1. Windows platform code compiles correctly
      # 2. Win32 GetDynamicTimeZoneInformation API works
      # 3. CLDR Windows-to-IANA timezone mapping works
      # -----------------------------------------------------------------------
      - name: Build Windows platform tests
        shell: bash
        run: |
          alr exec -- gprbuild -P test/integration/windows_platform_tests.gpr -p

      # -----------------------------------------------------------------------
      # Run Windows platform tests
      # -----------------------------------------------------------------------
      - name: Run Windows platform tests
        shell: bash
        env:
          TZIF_DATA_PATH: ${{ github.workspace }}/data/tzif
        run: |
          alr exec -- ./test/bin/test_windows_platform

      # -----------------------------------------------------------------------
      # Summary
      # -----------------------------------------------------------------------
      - name: Test Summary
        if: always()
        shell: bash
        run: |
          echo "========================================"
          echo "Windows Release Validation Complete"
          echo "========================================"
          echo "Version: ${{ github.event.inputs.version || 'dev' }}"
          echo "Ref: ${{ github.event.inputs.ref || github.ref }}"
          echo "Platform: windows-latest"
          echo "TZIF_OS: windows"
          echo "Alire: 2.0.2"
